## 设计说明

Filer的代码已经很久没有改动了，但是其实设计中存在不少的缺陷，客户端的工作也会时常抽风，最近我决心修改故障，可是却发现完全没有留下关于设计思路，通信协议的说明，这里只能重新再来处理一次。



### IP报告与广播协议

上线设备向IP服务器报告自身的ID和TCP服务器端口, 上线设备应该定时报告自身IP地址

~~~
ID\nport
~~~

ip服务器反馈`get`



IP服务器负责向上线设备分发其余设备的信息, 没有设备报文内容为`0`, 否则用`\n\n`分割不同的设备信息,每个设备的信息包含设备ID,端口号和IP地址,三个部分使用`\n`分割

~~~
ID\nport\nIP\n\nID\nport\nIP......
~~~

IP广播时,客户端没有反馈,但是应该持续接收信息

### IP服务器设计

IP服务器重新做了设计, 关于上线设备的记录,使用socket作为key, 信息记录在字典中. 这样的设计可以实现同一IP的多开(其实没用)

服务器同时维护两个线程, 一个线程负责每5秒钟发送一次广播, 另外一个线程负责监控上线设备. 不再设置专门的设备下线报文.

总之, 就是通过广播不断地发送在线设备信息, 另外要求在线设备定时的向服务器发送信息维护, 因为现在的服务器只会保存在线设备的信息一定的时间,然后就会过期, 过期时间暂时设置为5分钟.



### 客户端设计

现在要求客户端发送心跳包, 同时客户端也必须在每次接收到报文的时候完全更新设备列表.